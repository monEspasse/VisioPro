<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Détails Client - VisionPro</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ===== STYLES DE BASE ===== */
        :root {
            /* Couleurs principales */
            --primary-50: #f0f4ff;
            --primary-100: #d9e4ff;
            --primary-200: #b3c9ff;
            --primary-300: #8daef8;
            --primary-400: #6793f1;
            --primary-500: #4f46e5;
            --primary-600: #4338ca;
            --primary-700: #3730a3;
            --primary-800: #312e81;
            --primary-900: #1e1b4b;
            
            /* Échelles de gris */
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-400: #a3a3a3;
            --gray-500: #737373;
            --gray-600: #525252;
            --gray-700: #404040;
            --gray-800: #262626;
            --gray-900: #171717;
            
            /* Dégradés */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --gradient-danger: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --gradient-warning: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            
            /* Verre dépoli */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            
            /* Rayons de bordure */
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --radius-xl: 32px;
            --radius-full: 9999px;
            
            /* Animations */
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Réinitialisation et base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            color: var(--gray-800);
        }

        /* ===== UTILITAIRES ===== */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
        }

        /* ===== COMPOSANTS ===== */

        /* Boutons */
        .btn {
            position: relative;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Badges de statut */
        .status-badge {
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .badge-livre {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary-600);
            border: 1px solid rgba(67, 97, 238, 0.3);
        }

        .badge-lunette {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-perdu {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge-cancel {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Messages d'alerte */
        .alert-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            animation: slideInRight 0.3s ease-out;
            max-width: 300px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-message.success { background: var(--gradient-success); }
        .alert-message.error { background: var(--gradient-danger); }
        .alert-message.warning { background: var(--gradient-warning); }

        /* Loader moderne */
        .modern-loader {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse-avatar {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }

        .pulse-ring {
            position: absolute;
            top: -5px; left: -5px; right: -5px; bottom: -5px;
            border: 2px solid var(--primary-500);
            border-radius: 50%;
            animation: pulseRing 2s ease-out infinite;
        }

        @keyframes pulseRing {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.5; }
            100% { transform: scale(1.2); opacity: 0; }
        }

        .wave-loader {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 20px;
        }

        .wave-bar {
            width: 4px;
            background: var(--gradient-primary);
            border-radius: 2px;
            animation: wave 1.2s ease-in-out infinite;
        }

        .wave-bar:nth-child(1) { animation-delay: 0s; height: 5px; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 10px; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 15px; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; height: 10px; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; height: 5px; }

        @keyframes wave {
            0%, 60%, 100% { transform: scaleY(0.4); }
            30% { transform: scaleY(1); }
        }

        /* États d'erreur */
        .error-state {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-radius: var(--radius-md);
            border: 1px solid rgba(239, 68, 68, 0.2);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.1);
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .error-icon {
            width: 60px; height: 60px;
            border-radius: 50%;
            background: var(--gradient-danger);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .error-content {
            flex: 1;
        }

        .error-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ef4444;
            margin-bottom: 0.5rem;
        }

        .error-message {
            font-size: 0.9rem;
            color: #7f1d1d;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .retry-btn {
            background: var(--gradient-danger);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        /* ===== MODULES DE LA PAGE ===== */

        /* En-tête */
/* Dans la section .page-header */
.page-header {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    padding: 1.5rem 2rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    
    /* Rendre figé avec ajustement */
    position: sticky;
    top: 0;
    z-index: 100;
}

/* Version mobile - Ajustement spécifique */
@media (max-width: 768px) {
    .page-header {
        padding: 1rem;
        top: 0;
        border-radius: 0; /* Enlever les bords arrondis sur mobile pour un effet full width */
        margin-bottom: 1rem;
    }
    
    /* Compenser l'espace pour que les onglets ne soient pas cachés */
    .tabs-container {
        position: sticky;
        top: 70px; /* Hauteur approximative de l'en-tête sur mobile */
        z-index: 99;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 0 0.5rem;
        margin: 0 -1rem 1.5rem -1rem;
        width: calc(100% + 2rem);
        border-radius: 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
}

@media (max-width: 480px) {
    .tabs-container {
        top: 65px; /* Ajustement pour très petits écrans */
    }
}
        .page-header h1 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 2rem;
            margin: 0;
        }

        @media (max-width: 768px) {
            .page-header {
                padding: 1rem;
            }
            .page-header h1 {
                font-size: 1.5rem;
            }
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary-300);
        }

        /* Section héros du client */
        .client-hero {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .client-hero {
                grid-template-columns: 1fr;
            }
        }

        .client-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--glass-shadow);
        }

        .client-identity {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .client-avatar-lg {
            width: 80px; height: 80px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            color: white;
            font-size: 2rem;
        }

        .client-name-lg {
            font-size: 1.5rem;
            margin: 0 0 0.5rem 0;
            color: var(--gray-900);
            font-weight: 700;
        }

        .client-id {
            color: var(--gray-500);
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.05);
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            display: inline-block;
            margin-bottom: 1rem;
        }

        .client-status-badge {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .client-status-badge.active {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .client-status-badge.inactive {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .client-overview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .client-overview {
                grid-template-columns: 1fr;
            }
        }

        .overview-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-md);
            backdrop-filter: blur(5px);
        }

        .overview-icon {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            color: white;
        }

        .overview-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .overview-label {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        /* Contrôle de statut */
        .status-control {
            margin-bottom: 2rem;
        }

        .status-control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 220px;
        }

        .status-control-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-select-wrapper {
            position: relative;
            flex: 1;
        }

        .status-select {
            width: 100%;
            padding: 0.85rem 1.5rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: var(--gray-700);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%234f46e5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 16px;
            padding-right: 3rem;
        }

        .status-select:hover {
            background: rgba(79, 70, 229, 0.1);
            border-color: var(--primary-400);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
        }

        .status-select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .status-select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 2rem;
            overflow-x: auto;
            scrollbar-width: thin;
            background: white;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            padding: 0 1rem;
        }

        @media (max-width: 768px) {
            .tabs-container {
                position: sticky;
                top: 0;
                z-index: 100;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                padding: 0 0.5rem;
                margin: 0 -1rem 1.5rem -1rem;
                width: calc(100% + 2rem);
                border-radius: 0;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }
        }

        .tabs-container::-webkit-scrollbar {
            height: 6px;
        }

        .tabs-container::-webkit-scrollbar-thumb {
            background-color: var(--gray-400);
            border-radius: 3px;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-500);
            transition: all 0.3s var(--transition-smooth);
            white-space: nowrap;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .tab-btn {
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
                flex: 0 0 auto;
            }
        }

        @media (max-width: 480px) {
            .tab-btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.8rem;
            }
        }

        .tab-btn:hover {
            color: var(--primary-600);
        }

        .tab-btn.active {
            color: var(--primary-600);
            border-bottom-color: var(--primary-600);
        }

        /* Contenu des onglets */
        .tab-pane {
            display: none;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
            margin-bottom: 2rem;
            animation: fadeIn 0.4s var(--transition-smooth);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-pane.active {
            display: block;
        }

        /* Grilles de détails */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        .detail-section {
            background: var(--gray-50);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary-500);
            transition: all 0.3s var(--transition-smooth);
        }

        .detail-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.1rem;
            color: var(--primary-700);
            margin: 0 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-title i {
            color: var(--primary-500);
            background: rgba(79, 70, 229, 0.1);
            padding: 0.5rem;
            border-radius: var(--radius-sm);
        }

        .detail-item {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: white;
            border-radius: var(--radius-sm);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .detail-label {
            font-size: 0.85rem;
            color: var(--gray-500);
            font-weight: 500;
            display: block;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-size: 1rem;
            color: var(--gray-800);
            word-break: break-word;
            padding: 0.5rem 0;
            font-weight: 500;
        }

        /* Section médicale */
        .medical-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .medical-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .eye-section {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary-400);
            transition: all 0.3s var(--transition-smooth);
        }

        .eye-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }

        .eye-title {
            text-align: center;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary-600);
            position: relative;
            padding-bottom: 0.5rem;
        }

        .eye-title::after {
            content: '';
            position: absolute;
            bottom: 0; left: 50%;
            transform: translateX(-50%);
            width: 40px; height: 2px;
            background: var(--primary-400);
            border-radius: 2px;
        }

        /* Résumé paiement */
        .payment-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        @media (max-width: 768px) {
            .payment-summary {
                grid-template-columns: 1fr;
            }
        }

        .payment-card {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary-500);
            transition: all 0.3s var(--transition-smooth);
        }

        .payment-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .payment-label {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
        }

        .payment-amount {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Actions flottantes */
        .floating-actions {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 100;
        }

        @media (max-width: 768px) {
            .floating-actions {
                bottom: 1rem;
                right: 1rem;
            }
        }

        .floating-btn {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s var(--transition-smooth);
        }

        @media (max-width: 768px) {
            .floating-btn {
                width: 45px; height: 45px;
                font-size: 1.1rem;
            }
        }

        .floating-btn:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .floating-btn.print { background: var(--gradient-primary); }
        .floating-btn.back { background: var(--gradient-secondary); }
        .floating-btn.call { background: var(--gradient-success); }
        .floating-btn.complement { background: var(--gradient-warning); }

        /* Modales */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            animation: slideUp 0.4s var(--transition-smooth);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            color: white;
        }

        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.25rem;
            color: white;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        @media (max-width: 768px) {
            .modal-footer {
                flex-direction: column;
            }
            .modal-footer .btn {
                width: 100%;
                margin: 0;
            }
        }

        /* Formulaires */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s var(--transition-smooth);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-control:invalid {
            border-color: #ef4444;
        }

        /* Utilitaires supplémentaires */
        .mt-3 { margin-top: 1.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .d-flex { display: flex; }
        .align-center { align-items: center; }
        .gap-2 { gap: 0.75rem; }
        .flex-wrap { flex-wrap: wrap; }
    </style>
</head>
<body>
    <div class="container">
        <!-- En-tête de page -->
        <header class="page-header">
            <div class="page-header-left">
                <h1>Détails Client</h1>
            </div>
            <div class="user-profile">
                <span id="username-display"></span>
                <img src="https://ui-avatars.com/api/?name=Admin&background=6366f1&color=fff" 
                     alt="Photo de profil" 
                     class="user-avatar"
                     id="profile-image">
            </div>
        </header>

        <!-- Bouton retour -->
        <div class="mb-2">
            <button class="btn btn-primary" onclick="app.navigation.retour()">
                <i class="fas fa-arrow-left"></i> Retour
            </button>
        </div>

        <!-- Section héros client -->
        <div class="client-hero">
            <div class="client-card client-identity">
                <div class="client-avatar-lg">
                    <i class="fas fa-user"></i>
                </div>
                <h2 class="client-name-lg" id="client-name">Chargement...</h2>
                <div class="client-id">ID: <span id="client-id">-</span></div>
                <div class="client-status-badge" id="client-status">-</div>
            </div>

            <div class="client-card">
                <div class="client-overview">
                    <div class="overview-item">
                        <div class="overview-icon"><i class="fas fa-receipt"></i></div>
                        <div class="overview-value" id="net-amount">-</div>
                        <div class="overview-label">Net à Payer</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-icon"><i class="fas fa-wallet"></i></div>
                        <div class="overview-value" id="total-deposit">-</div>
                        <div class="overview-label">Total Paiement</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-icon"><i class="fas fa-hourglass-half"></i></div>
                        <div class="overview-value" id="remaining-amount">-</div>
                        <div class="overview-label">Reste à Payer</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contrôle de statut -->
        <div class="status-control">
            <div class="status-control-group">
                <div class="status-control-label">
                    <i class="fas fa-flag"></i>
                    <span>ÉTAPE DU DEAL</span>
                </div>
                <div class="d-flex align-center gap-2 flex-wrap">
                    <div class="status-select-wrapper">
                        <select class="status-select" id="status-select" aria-label="Changer l'étape du deal">
                            <option value="Lunette Disponible">Lunette Disponible</option>
                            <option value="Nouvelle vente">Nouvelle vente</option>
                            <option value="Livré">Livré</option>
                            <option value="Perdu">Perdu</option>
                            <option value="Cancel">Cancel</option>
                        </select>
                    </div>
                    <div class="status-badge badge-livre" id="current-status-badge">
                        <span class="status-indicator" style="background-color: var(--primary-600);"></span>
                        Actuel
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation par onglets -->
        <div class="tabs-container" role="tablist">
            <button class="tab-btn active" data-tab="info" role="tab" aria-selected="true">
                <i class="fas fa-info-circle"></i> Informations
            </button>
            <button class="tab-btn" data-tab="medical" role="tab" aria-selected="false">
                <i class="fas fa-stethoscope"></i> Détails Médicaux
            </button>
            <button class="tab-btn" data-tab="order" role="tab" aria-selected="false">
                <i class="fas fa-shopping-cart"></i> Commande
            </button>
            <button class="tab-btn" data-tab="insurance" role="tab" aria-selected="false">
                <i class="fas fa-shield-alt"></i> Tier Payant
            </button>
            <button class="tab-btn" data-tab="payment" role="tab" aria-selected="false">
                <i class="fas fa-credit-card"></i> Paiement
            </button>
        </div>

        <!-- Contenu des onglets -->
        <div id="info-tab" class="tab-pane active" role="tabpanel">
            <div class="detail-grid">
                <div class="detail-section">
                    <h3 class="section-title"><i class="fas fa-user"></i> Contact</h3>
                    <div class="detail-item">
                        <span class="detail-label">Nom Complet</span>
                        <p class="detail-value" id="client-fullname"></p>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Numéro de Contact</span>
                        <p class="detail-value" id="client-phone"></p>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Date de Naissance</span>
                        <p class="detail-value" id="client-birthdate"></p>
                    </div>
                </div>

                <div class="detail-section">
                    <h3 class="section-title"><i class="fas fa-building"></i> Entreprise</h3>
                    <div class="detail-item">
                        <span class="detail-label">Entreprise</span>
                        <p class="detail-value" id="client-company"></p>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Civilité</span>
                        <p class="detail-value" id="client-civility"></p>
                    </div>
                </div>

                <div class="detail-section">
                    <h3 class="section-title"><i class="fas fa-truck"></i> Delivery</h3>
                    <div class="detail-item">
                        <span class="detail-label">Date Livraison Prévue</span>
                        <p class="detail-value" id="client-delivery-date"></p>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Contact Livraison</span>
                        <p class="detail-value" id="client-delivery-contact"></p>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Téléphone du contact</span>
                        <p class="detail-value" id="client-delivery-phone"></p>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Adresse Livraison</span>
                        <p class="detail-value" id="client-delivery-address"></p>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Infos Complémentaires</span>
                        <p class="detail-value" id="client-delivery-info"></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="medical-tab" class="tab-pane">
            <div class="medical-grid">
                <div class="eye-section">
                    <h4 class="eye-title">Œil Droit (OD)</h4>
                    <div class="detail-item"><span class="detail-label">Sphere</span><p class="detail-value" id="od-sphere"></p></div>
                    <div class="detail-item"><span class="detail-label">Cylindre</span><p class="detail-value" id="od-cylinder"></p></div>
                    <div class="detail-item"><span class="detail-label">Axe</span><p class="detail-value" id="od-axis"></p></div>
                    <div class="detail-item"><span class="detail-label">ADD</span><p class="detail-value" id="od-add"></p></div>
                    <div class="detail-item"><span class="detail-label">DP</span><p class="detail-value" id="od-dp"></p></div>
                    <div class="detail-item"><span class="detail-label">Hauteur</span><p class="detail-value" id="od-height"></p></div>
                </div>

                <div class="eye-section">
                    <h4 class="eye-title">Œil Gauche (OG)</h4>
                    <div class="detail-item"><span class="detail-label">Sphere</span><p class="detail-value" id="og-sphere"></p></div>
                    <div class="detail-item"><span class="detail-label">Cylindre</span><p class="detail-value" id="og-cylinder"></p></div>
                    <div class="detail-item"><span class="detail-label">Axe</span><p class="detail-value" id="og-axis"></p></div>
                    <div class="detail-item"><span class="detail-label">ADD</span><p class="detail-value" id="og-add"></p></div>
                    <div class="detail-item"><span class="detail-label">DP</span><p class="detail-value" id="og-dp"></p></div>
                    <div class="detail-item"><span class="detail-label">Hauteur</span><p class="detail-value" id="og-height"></p></div>
                </div>
            </div>

            <div class="detail-section mt-3">
                <h3 class="section-title"><i class="fas fa-hospital"></i> Informations Médicales</h3>
                <div class="detail-grid">
                    <div class="detail-item"><span class="detail-label">Clinique</span><p class="detail-value" id="clinic"></p></div>
                    <div class="detail-item"><span class="detail-label">Ophtalmologue</span><p class="detail-value" id="ophthalmologist"></p></div>
                    <div class="detail-item"><span class="detail-label">Date de Soin</span><p class="detail-value" id="care-date"></p></div>
                </div>
            </div>
        </div>

        <div id="order-tab" class="tab-pane">
            <div class="detail-grid">
                <div class="detail-section">
                    <h3 class="section-title"><i class="fas fa-glasses"></i> Verres</h3>
                    <div class="detail-item"><span class="detail-label">Type de Verre</span><p class="detail-value" id="lens-type"></p></div>
                    <div class="detail-item"><span class="detail-label">Gamme des Verres</span><p class="detail-value" id="lens-range"></p></div>
                    <div class="detail-item"><span class="detail-label">Montant Verres</span><p class="detail-value" id="lens-amount"></p></div>
                </div>

                <div class="detail-section">
                    <h3 class="section-title"><i class="fas fa-eye"></i> Monture</h3>
                    <div class="detail-item"><span class="detail-label">Choix de Monture</span><p class="detail-value" id="frame-choice"></p></div>
                    <div class="detail-item"><span class="detail-label">Montant Monture</span><p class="detail-value" id="frame-amount"></p></div>
                </div>

                <div class="detail-section">
                    <h3 class="section-title"><i class="fas fa-store"></i> Vente</h3>
                    <div class="detail-item"><span class="detail-label">Agence</span><p class="detail-value" id="agency"></p></div>
                    <div class="detail-item"><span class="detail-label">Commercial</span><p class="detail-value" id="salesperson"></p></div>
                    <div class="detail-item"><span class="detail-label">Créé par</span><p class="detail-value" id="userperson"></p></div>
                </div>
            </div>
            <div class="detail-item mt-3">
                <span class="detail-label">Statut</span>
                <p class="detail-value" id="payment-status"></p>
            </div>
        </div>

        <div id="insurance-tab" class="tab-pane">
            <div class="detail-grid">
                <div class="detail-section">
                    <h3 class="section-title"><i class="fas fa-shield-alt"></i> Assurance</h3>
                    <div class="detail-item"><span class="detail-label">Assurance</span><p class="detail-value" id="insurance"></p></div>
                    <div class="detail-item"><span class="detail-label">Compagnie</span><p class="detail-value" id="insurance-company"></p></div>
                    <div class="detail-item"><span class="detail-label">Numéro Police</span><p class="detail-value" id="policy-number"></p></div>
                </div>

                <div class="detail-section">
                    <h3 class="section-title"><i class="fas fa-percentage"></i> Couverture</h3>
                    <div class="detail-item"><span class="detail-label">Taux Couverture</span><p class="detail-value" id="coverage-rate"></p></div>
                    <div class="detail-item"><span class="detail-label">Nom Assuré Principal</span><p class="detail-value" id="insured-name"></p></div>
                    <div class="detail-item"><span class="detail-label">Part Assurance</span><p class="detail-value" id="insurance-part"></p></div>
                </div>
            </div>
        </div>

        <div id="payment-tab" class="tab-pane">
            <div class="payment-summary">
                <div class="payment-card"><div class="payment-label">Net à Payer</div><div class="payment-amount" id="net-amount-payment"></div></div>
                <div class="payment-card"><div class="payment-label">Acompte</div><div class="payment-amount" id="deposit-amount-payment"></div><div class="detail-value" id="deposit-date"></div></div>
                <div class="payment-card"><div class="payment-label">Complément 1</div><div class="payment-amount" id="complement1-amount"></div><div class="detail-value" id="complement1-date"></div></div>
                <div class="payment-card"><div class="payment-label">Complément 2</div><div class="payment-amount" id="complement2-amount"></div><div class="detail-value" id="complement2-date"></div></div>
                <div class="payment-card"><div class="payment-label">Reste à Payer</div><div class="payment-amount" id="remaining-amount-payment"></div></div>
            </div>
        </div>
    </div>

    <!-- Actions flottantes -->
    <div class="floating-actions">
        <button class="floating-btn print" title="Imprimer" onclick="app.impression.generer()">
            <i class="fas fa-print"></i>
        </button>
        <button class="floating-btn back" title="Retour" onclick="app.navigation.retour()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <button class="floating-btn call" title="Appeler" onclick="app.telephone.initier()">
            <i class="fas fa-phone"></i>
        </button>
        <button class="floating-btn complement" title="Ajouter complément" onclick="app.paiement.ouvrirModalComplement()">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Conteneur pour les modales dynamiques -->
    <div id="modal-container"></div>

    <!-- Modale de confirmation d'appel -->
    <div class="modal-overlay" id="callConfirmationModal">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
                <h3 class="modal-title">Confirmer l'appel</h3>
                <button class="modal-close" onclick="app.telephone.annuler()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmPhoneNumber" style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem;"></p>
                <div class="d-flex justify-content-center gap-2" style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-success" onclick="app.telephone.confirmer()">
                        <i class="fas fa-phone"></i> Appeler
                    </button>
                    <button class="btn btn-secondary" onclick="app.telephone.annuler()">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale de consignation d'appel -->
    <div class="modal-overlay" id="logCallModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-clipboard-list"></i> Consigner l'appel</h3>
                <button class="modal-close" onclick="app.telephone.fermerConsignation()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ID Client</label>
                    <input type="text" id="logClientId" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Utilisateur</label>
                    <input type="text" id="logUser" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Numéro appelé</label>
                    <input type="text" id="logPhoneNumber" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        Notes de l'appel <span style="color: #ef4444;">*</span>
                    </label>
                    <textarea id="logNote" class="form-control" rows="4" placeholder="Décrivez le contenu de l'appel, les décisions prises, les actions à suivre..."></textarea>
                    <div style="font-size: 0.8rem; color: var(--gray-500); margin-top: 5px;">
                        Minimum 5 caractères requis
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.telephone.fermerConsignation()">
                    <i class="fas fa-times"></i> Ne Pas Consigner
                </button>
                <button class="btn btn-primary" id="saveLogBtn" onclick="app.telephone.sauvegarderConsignation()">
                    <i class="fas fa-save"></i> Consigner
                </button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            "use strict";

            // ================================
            // CONFIGURATION
            // ================================
            const CONFIG = {
                API_BASE: 'https://script.google.com/macros/s/AKfycbzFmMSBTBdw8_DcCC1R0Oice_ecTCrggK4Gp59elsQSwhwdRjuuweo18_z79nTZUv6pgA/exec',
                CALL: {
                    AUTO_LOG_DELAY: 2000,
                    MAX_LOG_TIME: 10 * 60 * 1000,
                    MIN_NOTE_LENGTH: 5
                },
                SESSION_KEYS: {
                    USER: 'utilisateur',
                    SELECTED_CLIENT: 'selectedClient'
                }
            };

            // ================================
            // UTILITAIRES
            // ================================
            const Utils = {
                // Gestion de l'authentification
                getCurrentUser: () => sessionStorage.getItem(CONFIG.SESSION_KEYS.USER) || localStorage.getItem(CONFIG.SESSION_KEYS.USER),
                
                hasCaisseRights: () => sessionStorage.getItem('hasCaisseAccess') === 'true',
                
                redirectToLogin: () => window.location.href = 'code.html',
                
                // Formatage
                formatPhoneNumber: (phoneString) => {
                    if (!phoneString) return '';
                    const phoneStr = String(phoneString);
                    if (phoneStr.length === 10 && phoneStr.startsWith('0')) {
                        return phoneStr.replace(/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/, '$1 $2 $3 $4 $5');
                    }
                    return phoneStr;
                },
                
                cleanPhoneNumber: (phoneNumber) => {
                    if (!phoneNumber) return null;
                    let digitsOnly = String(phoneNumber).replace(/\D/g, '');
                    if (digitsOnly.length > 10) digitsOnly = digitsOnly.slice(-10);
                    return digitsOnly.length === 10 ? digitsOnly : null;
                },
                
                formatDate: (dateString) => {
                    if (!dateString) return null;
                    const date = new Date(dateString);
                    return date.toLocaleDateString('fr-FR');
                },
                
                // Messages temporaires
                showMessage: (message, type = 'success', duration = 3000) => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `alert-message ${type}`;
                    msgDiv.textContent = message;
                    document.body.appendChild(msgDiv);
                    
                    setTimeout(() => {
                        msgDiv.style.animation = 'slideInRight 0.3s ease-out reverse';
                        setTimeout(() => {
                            if (msgDiv.parentNode) document.body.removeChild(msgDiv);
                        }, 300);
                    }, duration);
                },
                
                // Chargement
                showLoader: (element, message = 'Chargement des données') => {
                    if (!element) return;
                    element.innerHTML = `
                        <div class="modern-loader">
                            <div class="pulse-avatar">
                                <div class="pulse-ring"></div>
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="loading-content">
                                <div class="loading-text">${message}</div>
                                <div class="loading-subtext">Patientez un instant...</div>
                                <div class="wave-loader">
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                </div>
                            </div>
                        </div>
                    `;
                },
                
                showError: (element, errorMessage) => {
                    if (!element) return;
                    element.innerHTML = `
                        <div class="error-state">
                            <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="error-content">
                                <div class="error-title">Erreur de chargement</div>
                                <div class="error-message">${errorMessage}</div>
                                <button class="retry-btn" onclick="location.reload()">
                                    <i class="fas fa-redo"></i> Réessayer
                                </button>
                            </div>
                        </div>
                    `;
                },
                
                // Modales
                closeModal: () => {
                    const modal = document.querySelector('.modal-overlay.active');
                    if (modal) {
                        modal.classList.remove('active');
                        setTimeout(() => {
                            document.getElementById('modal-container').innerHTML = '';
                        }, 300);
                    }
                }
            };

            // ================================
            // GESTIONNAIRE API
            // ================================
            const API = {
                async get(endpoint, params = {}) {
                    const url = new URL(CONFIG.API_BASE);
                    Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                    return response.json();
                },
                
                async post(action, data) {
                    const url = `${CONFIG.API_BASE}?action=${action}`;
                    
                    // Mode no-cors pour les actions d'écriture (comme dans l'original)
                    await fetch(url, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    return { success: true };
                }
            };

            // ================================
            // GESTIONNAIRE DE DONNÉES CLIENT
            // ================================
            const ClientData = {
                currentId: null,
                
                async load(id) {
                    if (!id) {
                        const stored = localStorage.getItem(CONFIG.SESSION_KEYS.SELECTED_CLIENT);
                        id = stored ? JSON.parse(stored)[0] : null;
                        if (!id) throw new Error("Aucun ID client trouvé");
                    }
                    
                    this.currentId = id;
                    Utils.showLoader(document.getElementById('client-name'));
                    
                    try {
                        const result = await API.get('getClientDetails', { 
                            action: 'getClientDetails', 
                            clientId: id 
                        });
                        
                        if (!result.success) throw new Error(result.message || "Erreur serveur");
                        this.display(result.data);
                        
                    } catch (error) {
                        console.error("Erreur chargement:", error);
                        Utils.showError(document.getElementById('client-name'), error.message);
                    }
                },
                
                display(data) {
                    console.log("Données client reçues:", data);
                    
                    // Calculs financiers
                    const deposit = parseFloat(data["Acompte (FCFA)"]) || 0;
                    const comp1 = parseFloat(data["Complement 1"]) || 0;
                    const comp2 = parseFloat(data["Complement 2"]) || 0;
                    const totalDeposit = deposit + comp1 + comp2;
                    
                    // Remplissage des champs
                    const setText = (id, value, suffix = '') => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = value ? `${value}${suffix}` : (suffix ? `0 ${suffix}` : '');
                    };
                    
                    // Informations générales
                    setText('total-deposit', totalDeposit.toLocaleString('fr-FR'), ' FCFA');
                    setText('client-id', data["ID client"]);
                    setText('client-name', data["Nom Complet Client"] || 'Nom non renseigné');
                    setText('client-fullname', data["Nom Complet Client"]);
                    setText('client-phone', Utils.formatPhoneNumber(data["Numéro Contact"]));
                    setText('client-birthdate', Utils.formatDate(data["Date Naissance"]));
                    setText('client-company', data.Entreprise);
                    setText('client-civility', data.Civilité);
                    setText('client-delivery-date', Utils.formatDate(data["Date Livraison Prévue"]));
                    setText('client-delivery-contact', data["Contact Livraison"]);
                    setText('client-delivery-phone', Utils.formatPhoneNumber(data["Téléphone du contact"]));
                    setText('client-delivery-address', data["Adresse Livraison"]);
                    setText('client-delivery-info', data["Infos Complémentaires"]);
                    
                    // Médical OD
                    setText('od-sphere', data["OD Sphere"]);
                    setText('od-cylinder', data["OD Cylindre"]);
                    setText('od-axis', data["OD Axe"]);
                    setText('od-add', data["OD ADD"]);
                    setText('od-dp', data["OD DP"]);
                    setText('od-height', data["OD Hauteur"]);
                    
                    // Médical OG
                    setText('og-sphere', data["OG Sphere"]);
                    setText('og-cylinder', data["OG Cylindre"]);
                    setText('og-axis', data["OG Axe"]);
                    setText('og-add', data["OG ADD"]);
                    setText('og-dp', data["OG DP"]);
                    setText('og-height', data["OG Hauteur"]);
                    
                    // Infos médicales
                    setText('clinic', data.Clinique);
                    setText('ophthalmologist', data.Ophtalmo);
                    setText('care-date', Utils.formatDate(data["Date de Soin"]));
                    
                    // Commande
                    setText('lens-type', data["Type de Verre"]);
                    setText('lens-range', data["Gamme des Verres"]);
                    setText('frame-choice', data["Choix de Monture"]);
                    setText('frame-amount', data["Montant Monture (FCFA)"], ' FCFA');
                    setText('lens-amount', data["Montant Verres (FCFA)"], ' FCFA');
                    setText('agency', data.Agence);
                    setText('salesperson', data.Commercial);
                    setText('userperson', data.Utilisateur);
                    
                    // Assurance
                    setText('insurance', data.Assurance);
                    setText('insurance-company', data["Compagnie Assurance"]);
                    setText('policy-number', data["Numéro Police"]);
                    setText('coverage-rate', data["Taux Couverture (%)"], '%');
                    setText('insured-name', data["Nom Assureé principal"]);
                    setText('insurance-part', data["Part Assurance (FCFA)"], ' FCFA');
                    
                    // Paiement
                    setText('net-amount', data["Net à Payer (FCFA)"], ' FCFA');
                    setText('net-amount-payment', data["Net à Payer (FCFA)"], ' FCFA');
                    setText('deposit-amount-payment', data["Acompte (FCFA)"], ' FCFA');
                    setText('deposit-date', data["Acompte (FCFA)"] ? Utils.formatDate(data["Date Enregistrement"]) : '');
                    setText('complement1-amount', data["Complement 1"], ' FCFA');
                    setText('complement1-date', Utils.formatDate(data["Date Comp1"]));
                    setText('complement2-amount', data["Complement 2"], ' FCFA');
                    setText('complement2-date', Utils.formatDate(data["Date Comp2"]));
                    setText('remaining-amount', data["Reste à Payer (FCFA)"], ' FCFA');
                    setText('remaining-amount-payment', data["Reste à Payer (FCFA)"], ' FCFA');
                    setText('payment-status', data["Statut de la vente"]);
                    
                    // Statut client
                    const statusEl = document.getElementById('client-status');
                    const statutVente = data["Statut de la vente"] || '';
                    statusEl.textContent = statutVente;
                    statusEl.className = 'client-status-badge';
                    if (statutVente === 'Cancel' || statutVente === 'Perdu') {
                        statusEl.classList.add('inactive');
                    } else {
                        statusEl.classList.add('active');
                    }
                    
                    // Initialiser le sélecteur de statut
                    setTimeout(() => {
                        const select = document.getElementById('status-select');
                        if (select && statutVente) select.value = statutVente;
                        StatusManager.updateBadge(statutVente);
                    }, 100);
                }
            };

            // ================================
            // GESTION DES ONGLETS
            // ================================
            const TabManager = {
                init() {
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const tabId = btn.dataset.tab;
                            this.activate(tabId);
                        });
                    });
                },
                
                activate(tabId) {
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                    
                    document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                }
            };

            // ================================
            // GESTION DU STATUT
            // ================================
            const StatusManager = {
                pendingChange: null,
                currentClientId: null,
                currentOldStatus: null,
                
                updateBadge(status) {
                    const badge = document.getElementById('current-status-badge');
                    if (!badge) return;
                    
                    badge.className = 'status-badge';
                    
                    const statusMap = {
                        'Lunette Disponible': { class: 'badge-lunette', text: 'Disponible', color: '#10b981' },
                        'Livré': { class: 'badge-livre', text: 'Livré', color: 'var(--primary-600)' },
                        'Perdu': { class: 'badge-perdu', text: 'Perdu', color: '#f59e0b' },
                        'Cancel': { class: 'badge-cancel', text: 'Annulé', color: '#ef4444' },
                        'Nouvelle vente': { class: 'badge-livre', text: 'Nouvelle vente', color: 'var(--primary-600)' }
                    };
                    
                    const config = statusMap[status] || statusMap['Nouvelle vente'];
                    badge.classList.add(config.class);
                    badge.innerHTML = `<span class="status-indicator" style="background-color: ${config.color};"></span> ${config.text}`;
                    
                    badge.style.animation = 'fadeIn 0.5s var(--transition-smooth)';
                    setTimeout(() => { badge.style.animation = ''; }, 500);
                },
                
                async handleChange() {
                    const select = document.getElementById('status-select');
                    const newStatus = select.value;
                    if (!newStatus) return;
                    
                    this.currentClientId = document.getElementById('client-id').textContent;
                    this.currentOldStatus = document.getElementById('payment-status').textContent || 'Non défini';
                    
                    if (!this.currentClientId || this.currentClientId === '-') {
                        Utils.showMessage("❌ ID client non trouvé", "error");
                        select.value = this.currentOldStatus;
                        return;
                    }

                    if (newStatus === "Livré") {
                        const remainingText = document.getElementById('remaining-amount').textContent;
                        const remaining = parseFloat(remainingText.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                        
                        if (remaining > 0) {
                            Utils.showMessage("❌ Impossible de livrer : solde restant à payer", "error", 5000);
                            setTimeout(() => PaymentManager.ouvrirModalComplement(), 100);
                            select.value = this.currentOldStatus;
                            return;
                        }
                        
                        this.pendingChange = newStatus;
                        DeliveryManager.showModal();
                    } else {
                        if (confirm(`Voulez-vous vraiment changer le statut de "${this.currentOldStatus}" à "${newStatus}" ?`)) {
                            await this.update(newStatus);
                        } else {
                            select.value = this.currentOldStatus;
                        }
                    }
                },
                
                async update(newStatus, deliveryInfo = null) {
                    const select = document.getElementById('status-select');
                    const clientId = this.currentClientId || document.getElementById('client-id').textContent;
                    const oldStatus = this.currentOldStatus || document.getElementById('payment-status').textContent;
                    const username = Utils.getCurrentUser();
                    
                    select.disabled = true;
                    
                    try {
                        await API.post('updateDealStatus', {
                            action: 'updateDealStatus',
                            clientId,
                            oldStatus,
                            newStatus,
                            utilisateur: username,
                            ...deliveryInfo
                        });
                        
                        // Mise à jour UI
                        document.getElementById('client-status').textContent = newStatus;
                        document.getElementById('payment-status').textContent = newStatus;
                        select.value = newStatus;
                        this.updateBadge(newStatus);
                        
                        Utils.showMessage("✅ Statut mis à jour avec succès !", "success");
                        
                        // Recharger les données
                        setTimeout(() => ClientData.load(clientId), 500);
                        
                    } catch (error) {
                        console.error('Erreur statut:', error);
                        Utils.showMessage("❌ Erreur lors de la mise à jour", "error");
                        select.value = oldStatus;
                        this.updateBadge(oldStatus);
                    } finally {
                        select.disabled = false;
                        this.pendingChange = null;
                        this.currentClientId = null;
                        this.currentOldStatus = null;
                    }
                }
            };

            // ================================
            // GESTION DES PAIEMENTS (COMPLÉMENTS)
            // ================================
            const PaymentManager = {
                ouvrirModalComplement() {
                    if (!Utils.hasCaisseRights()) {
                        Utils.showMessage("⛔ Accès refusé", "error");
                        return;
                    }
                    
                    const clientId = document.getElementById('client-id').textContent;
                    const clientName = document.getElementById('client-name').textContent;
                    
                    // Récupérer les données financières
                    const net = parseFloat(document.getElementById('net-amount').textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                    const acompte = parseFloat(document.getElementById('deposit-amount-payment').textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                    const comp1 = parseFloat(document.getElementById('complement1-amount').textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                    const comp2 = parseFloat(document.getElementById('complement2-amount').textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                    const reste = parseFloat(document.getElementById('remaining-amount').textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                    
                    const modalContainer = document.getElementById('modal-container');
                    
                    if (reste <= 0) {
                        modalContainer.innerHTML = `
                            <div class="modal-overlay active">
                                <div class="modal">
                                    <div class="modal-header">
                                        <h3 class="modal-title">Ajout de complément</h3>
                                        <button class="modal-close" onclick="Utils.closeModal()">&times;</button>
                                    </div>
                                    <div class="modal-body">
                                        <p style="color: var(--gray-600); margin-bottom: 1rem;">Client: <strong>${clientName}</strong> (ID: ${clientId})</p>
                                        <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: var(--radius-sm); border-left: 4px solid #ef4444;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; color: #ef4444;">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                <strong>Impossible d'ajouter un complément</strong>
                                            </div>
                                            <p style="color: #7f1d1d; margin-top: 0.5rem;">Le solde est déjà réglé</p>
                                        </div>
                                        <div style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-sm); margin-top: 1rem;">
                                            <p style="color: var(--gray-600); margin-bottom: 0.5rem;">Reste à payer</p>
                                            <p style="font-size: 1.5rem; font-weight: 700; color: #10b981;">0 FCFA</p>
                                            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 0.5rem;">
                                                <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                                <span style="color: #10b981; font-weight: 600;">Solde entièrement réglé</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-primary" onclick="Utils.closeModal()">Fermer</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Déterminer le type de paiement
                    let paymentType = '';
                    let maxAmount = reste;
                    
                    if (acompte === 0) paymentType = 'Acompte';
                    else if (comp1 === 0) paymentType = 'Complement 1';
                    else if (comp2 === 0) paymentType = 'Complement 2';
                    else {
                        paymentType = 'Complement 2 (Addition)';
                        maxAmount = reste;
                    }
                    
                    const today = new Date().toISOString().split('T')[0];
                    
                    modalContainer.innerHTML = `
                        <div class="modal-overlay active">
                            <div class="modal">
                                <div class="modal-header">
                                    <h3 class="modal-title">Ajout de complément</h3>
                                    <button class="modal-close" onclick="Utils.closeModal()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <p style="color: var(--gray-600); margin-bottom: 1rem;">Client: <strong>${clientName}</strong> (ID: ${clientId})</p>
                                    
                                    <div style="background: var(--gray-50); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem; border-left: 4px solid var(--primary-500);">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                            <span style="color: var(--gray-600);">Net à payer:</span>
                                            <strong>${net.toLocaleString('fr-FR')} FCFA</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                            <span style="color: var(--gray-600);">Déjà payé:</span>
                                            <strong>${(acompte + comp1 + comp2).toLocaleString('fr-FR')} FCFA</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-weight: 600; color: var(--primary-600); border-top: 1px solid var(--gray-200); padding-top: 0.5rem;">
                                            <span>Reste à payer:</span>
                                            <strong>${reste.toLocaleString('fr-FR')} FCFA</strong>
                                        </div>
                                    </div>
                                    
                                    <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem; text-align: center; border-left: 4px solid #10b981;">
                                        <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                            <i class="fas fa-info-circle" style="color: #10b981;"></i>
                                            <strong>Type de paiement: ${paymentType}</strong>
                                        </div>
                                    </div>
                                    
                                    <form id="complementForm">
                                        <input type="hidden" id="clientId" value="${clientId}">
                                        <input type="hidden" id="paymentType" value="${paymentType}">
                                        
                                        <div class="form-group">
                                            <label for="complementAmount" class="form-label">
                                                Montant (FCFA)
                                                <span style="color: var(--gray-500); font-size: 0.8rem;">
                                                    (Maximum: ${maxAmount.toLocaleString('fr-FR')} FCFA)
                                                </span>
                                            </label>
                                            <input type="number" id="complementAmount" class="form-control" 
                                                   placeholder="5000" required min="1" max="${maxAmount}">
                                            <div id="amountFeedback" style="font-size: 0.8rem; margin-top: 5px;"></div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="complementDate" class="form-label">Date</label>
                                            <input type="date" id="complementDate" class="form-control" required value="${today}">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="complementNotes" class="form-label">Notes</label>
                                            <textarea id="complementNotes" class="form-control" rows="3"
                                                      placeholder="Moyen de paiement, référence..."></textarea>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" onclick="Utils.closeModal()">Annuler</button>
                                    <button class="btn btn-primary" onclick="PaymentManager.soumettreComplement()">
                                        <i class="fas fa-check"></i> Enregistrer ${paymentType}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Validation du montant
                    const amountInput = document.getElementById('complementAmount');
                    if (amountInput) {
                        amountInput.addEventListener('input', () => this.validerMontant(amountInput, maxAmount));
                        amountInput.focus();
                    }
                },
                
                validerMontant(input, maxAmount) {
                    const amount = parseFloat(input.value) || 0;
                    const feedback = document.getElementById('amountFeedback');
                    const submitBtn = document.querySelector('#modal-container .btn-primary');
                    
                    if (!feedback || !submitBtn) return;
                    
                    if (amount <= 0) {
                        feedback.innerHTML = '<span style="color: var(--gray-500);">Veuillez saisir un montant</span>';
                        submitBtn.disabled = true;
                    } else if (amount > maxAmount) {
                        feedback.innerHTML = `<span style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Le montant ne peut pas dépasser ${maxAmount.toLocaleString('fr-FR')} FCFA</span>`;
                        submitBtn.disabled = true;
                    } else {
                        const resteApres = maxAmount - amount;
                        feedback.innerHTML = `<span style="color: #10b981;"><i class="fas fa-check-circle"></i> Montant valide - Reste après paiement: ${resteApres.toLocaleString('fr-FR')} FCFA</span>`;
                        submitBtn.disabled = false;
                    }
                },
                
                async soumettreComplement() {
                    const form = document.getElementById('complementForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    
                    const amount = parseFloat(document.getElementById('complementAmount').value);
                    const maxAmount = parseFloat(document.getElementById('complementAmount').max);
                    const paymentType = document.getElementById('paymentType').value;
                    
                    if (amount > maxAmount) {
                        Utils.showMessage("Le montant dépasse le maximum autorisé", "error");
                        return;
                    }
                    
                    const username = Utils.getCurrentUser();
                    const clientName = document.getElementById('client-name').textContent;
                    const agency = document.getElementById('agency').textContent;
                    
                    // Calcul du montant final si addition
                    let finalAmount = amount;
                    if (paymentType === 'Complement 2 (Addition)') {
                        const currentComp2 = parseFloat(document.getElementById('complement2-amount').textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                        finalAmount = currentComp2 + amount;
                    }
                    
                    const complementData = {
                        action: 'addComplement',
                        clientId: document.getElementById('clientId').value,
                        amount: finalAmount,
                        date: document.getElementById('complementDate').value,
                        notes: document.getElementById('complementNotes').value.trim(),
                        utilisateur: username,
                        clientName,
                        agence: agency,
                        paymentType,
                        originalAmount: amount,
                        maxAmount
                    };
                    
                    const submitBtn = document.querySelector('#modal-container .btn-primary');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enregistrement...';
                    
                    try {
                        await API.post('addComplement', complementData);
                        
                        Utils.showMessage(`✅ ${paymentType} enregistré avec succès !`, "success");
                        Utils.closeModal();
                        
                        setTimeout(() => ClientData.load(complementData.clientId), 500);
                        
                    } catch (error) {
                        console.error("Erreur complément:", error);
                        Utils.showMessage("❌ Erreur de connexion au serveur", "error");
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-check"></i> Enregistrer';
                    }
                }
            };

            // ================================
            // GESTION DE LA LIVRAISON
            // ================================
            const DeliveryManager = {
                async showModal() {
                    const modalContainer = document.getElementById('modal-container');
                    
                    modalContainer.innerHTML = `
                        <div class="modal-overlay active">
                            <div class="modal">
                                <div class="modal-header">
                                    <h3 class="modal-title">📦 Confirmation de Livraison</h3>
                                    <button class="modal-close" onclick="DeliveryManager.cancel()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <p style="margin-bottom: 1.5rem; color: var(--gray-600);">
                                        Vous êtes sur le point de marquer ce deal comme <strong>"Livré"</strong>.
                                    </p>
                                    
                                    <div class="form-group">
                                        <label for="nettoyantQuantity" class="form-label">Quantité de nettoyant</label>
                                        <input type="number" id="nettoyantQuantity" class="form-control" value="1" min="0">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="etuiQuantity" class="form-label">Quantité d'étui</label>
                                        <input type="number" id="etuiQuantity" class="form-control" value="1" min="0">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="etuiReference" class="form-label">Référence de l'étui</label>
                                        <select id="etuiReference" class="form-control">
                                            <option value="">-- Chargement des références --</option>
                                        </select>
                                    </div>
                                    
                                    <div id="customEtuiContainer" style="display: none;">
                                        <label for="customEtuiReference" class="form-label">Référence personnalisée</label>
                                        <input type="text" id="customEtuiReference" class="form-control" placeholder="Saisissez la référence">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" onclick="DeliveryManager.cancel()">Annuler</button>
                                    <button class="btn btn-primary" onclick="DeliveryManager.confirm()">✅ Confirmer la Livraison</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    await this.loadEtuiReferences();
                    this.setupListeners();
                },
                
                setupListeners() {
                    const etuiQty = document.getElementById('etuiQuantity');
                    const etuiRef = document.getElementById('etuiReference');
                    
                    etuiQty.addEventListener('input', () => {
                        const container = document.getElementById('customEtuiContainer');
                        if (etuiQty.value > 0 && etuiRef.value === 'autre') {
                            container.style.display = 'block';
                        } else {
                            container.style.display = 'none';
                        }
                    });
                    
                    etuiRef.addEventListener('change', () => {
                        const container = document.getElementById('customEtuiContainer');
                        if (etuiQty.value > 0 && etuiRef.value === 'autre') {
                            container.style.display = 'block';
                        } else {
                            container.style.display = 'none';
                        }
                    });
                },
                
                async loadEtuiReferences() {
                    try {
                        const clientAgency = document.getElementById('agency').textContent.trim();
                        if (!clientAgency) {
                            document.getElementById('etuiReference').innerHTML = '<option value="">Agence non définie</option>';
                            return;
                        }
                        
                        const data = await API.get('stocketuis', { action: 'stocketuis' });
                        
                        const etuiSelect = document.getElementById('etuiReference');
                        if (!etuiSelect) return;
                        
                        etuiSelect.innerHTML = '<option value="">-- Sélectionnez une référence --</option>';
                        
                        if (data.success && data.data?.rows) {
                            const filtered = data.data.rows
                                .filter(row => row && row.length >= 2 && row[0] && row[1] && row[1].toLowerCase() === clientAgency.toLowerCase())
                                .map(row => row[0])
                                .filter((v, i, a) => a.indexOf(v) === i);
                            
                            if (filtered.length > 0) {
                                filtered.sort().forEach(etui => {
                                    const option = document.createElement('option');
                                    option.value = etui;
                                    option.textContent = etui;
                                    etuiSelect.appendChild(option);
                                });
                            }
                            
                            const autre = document.createElement('option');
                            autre.value = 'autre';
                            autre.textContent = 'Autre';
                            etuiSelect.appendChild(autre);
                        }
                        
                    } catch (error) {
                        console.error('Erreur chargement étuis:', error);
                        document.getElementById('etuiReference').innerHTML = '<option value="">Erreur de chargement</option>';
                    }
                },
                
                cancel() {
                    Utils.closeModal();
                    const select = document.getElementById('status-select');
                    if (select && StatusManager.currentOldStatus) {
                        select.value = StatusManager.currentOldStatus;
                    }
                    StatusManager.pendingChange = null;
                },
                
                confirm() {
                    const nettoyantQty = parseInt(document.getElementById('nettoyantQuantity').value) || 0;
                    const etuiQty = parseInt(document.getElementById('etuiQuantity').value) || 0;
                    let etuiRef = document.getElementById('etuiReference').value;
                    
                    if (etuiQty > 0) {
                        if (etuiRef === 'autre') {
                            etuiRef = document.getElementById('customEtuiReference')?.value;
                            if (!etuiRef || etuiRef.trim() === '') {
                                Utils.showMessage("Veuillez saisir la référence de l'étui", "error");
                                return;
                            }
                        } else if (!etuiRef || etuiRef === '' || etuiRef === '-- Sélectionnez une référence --') {
                            Utils.showMessage("Veuillez sélectionner une référence d'étui", "error");
                            return;
                        }
                    } else {
                        etuiRef = '';
                    }
                    
                    Utils.closeModal();
                    StatusManager.update(StatusManager.pendingChange, {
                        nettoyantQuantity: nettoyantQty,
                        etuiQuantity: etuiQty,
                        etuiReference: etuiRef
                    });
                }
            };

            // ================================
            // GESTION DES APPELS TÉLÉPHONIQUES
            // ================================
            const CallManager = {
                currentCallData: null,
                
                initier() {
                    const phoneEl = document.getElementById('client-phone');
                    if (!phoneEl) return;
                    
                    const rawNumber = phoneEl.textContent.trim();
                    const cleaned = Utils.cleanPhoneNumber(rawNumber);
                    
                    if (!cleaned) {
                        Utils.showMessage('Numéro de téléphone invalide ou non disponible', 'error');
                        return;
                    }
                    
                    this.currentCallData = {
                        phoneNumber: cleaned,
                        clientId: document.getElementById('client-id')?.textContent || 'N/A',
                        username: Utils.getCurrentUser() || 'Utilisateur inconnu',
                        timestamp: Date.now()
                    };
                    
                    document.getElementById('confirmPhoneNumber').textContent = Utils.formatPhoneNumber(cleaned);
                    document.getElementById('callConfirmationModal').classList.add('active');
                    document.body.style.overflow = 'hidden';
                },
                
                confirmer() {
                    if (!this.currentCallData?.phoneNumber) return;
                    
                    localStorage.setItem('pendingCallLog', JSON.stringify(this.currentCallData));
                    window.location.href = `tel:${this.currentCallData.phoneNumber}`;
                    
                    this.annuler(); // ferme la modale
                    
                    setTimeout(() => this.ouvrirConsignation(), CONFIG.CALL.AUTO_LOG_DELAY);
                },
                
                annuler() {
                    const modal = document.getElementById('callConfirmationModal');
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                    this.currentCallData = null;
                },
                
                ouvrirConsignation() {
                    const stored = localStorage.getItem('pendingCallLog');
                    if (!stored) return;
                    
                    const callInfo = JSON.parse(stored);
                    const isRecent = (Date.now() - callInfo.timestamp) <= CONFIG.CALL.MAX_LOG_TIME;
                    
                    if (isRecent) {
                        document.getElementById('logClientId').value = callInfo.clientId;
                        document.getElementById('logUser').value = callInfo.username;
                        document.getElementById('logPhoneNumber').value = Utils.formatPhoneNumber(callInfo.phoneNumber);
                        
                        const modal = document.getElementById('logCallModal');
                        modal.classList.add('active');
                        document.body.style.overflow = 'hidden';
                        
                        setTimeout(() => document.getElementById('logNote')?.focus(), 100);
                    } else {
                        localStorage.removeItem('pendingCallLog');
                    }
                },
                
                fermerConsignation() {
                    const modal = document.getElementById('logCallModal');
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                    document.getElementById('logNote').value = '';
                    localStorage.removeItem('pendingCallLog');
                },
                
                async sauvegarderConsignation() {
                    const note = document.getElementById('logNote').value.trim();
                    
                    if (note.length < CONFIG.CALL.MIN_NOTE_LENGTH) {
                        Utils.showMessage(`Note d'au moins ${CONFIG.CALL.MIN_NOTE_LENGTH} caractères`, "warning");
                        document.getElementById('logNote').focus();
                        return;
                    }
                    
                    const logData = {
                        action: 'logCall',
                        clientId: document.getElementById('logClientId').value,
                        user: document.getElementById('logUser').value,
                        phoneNumber: Utils.cleanPhoneNumber(document.getElementById('logPhoneNumber').value),
                        note: note,
                        timestamp: new Date().toISOString()
                    };
                    
                    const saveBtn = document.getElementById('saveLogBtn');
                    const originalText = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enregistrement...';
                    saveBtn.disabled = true;
                    
                    try {
                        await API.post('logCall', logData);
                        
                        Utils.showMessage('✅ Appel consigné avec succès!', 'success');
                        this.fermerConsignation();
                        
                    } catch (error) {
                        console.error("Erreur consignation:", error);
                        Utils.showMessage('❌ Erreur lors de l\'enregistrement', 'error');
                    } finally {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                        localStorage.removeItem('pendingCallLog');
                    }
                }
            };

            // ================================
            // GESTION DE L'IMPRESSION / PDF
            // ================================
            const ImpressionManager = {
                async generer() {
                    const clientId = document.getElementById('client-id').textContent;
                    
                    try {
                        Utils.showLoader(document.createElement('div'), 'Génération du PDF...');
                        
                        // 1. Demander la création du reçu
                        await API.post('addrecu', { clientId });
                        
                        // 2. Attendre un peu
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        // 3. Récupérer l'URL du PDF
                        const result = await API.get('getrecucaissepdf', { action: 'getrecucaissepdf' });
                        
                        let pdfUrl = null;
                        if (result.succès && result.data?.pdfUrl) {
                            pdfUrl = result.data.pdfUrl;
                        } else if (result.message === "Le PDF est en cours de génération. Veuillez patienter quelques secondes.") {
                            Utils.showMessage("PDF en cours de génération, veuillez réessayer", "warning");
                            return;
                        } else {
                            throw new Error("Erreur lors de la génération du PDF");
                        }
                        
                        if (pdfUrl) {
                            window.open(pdfUrl, '_blank');
                            Utils.showMessage("PDF généré avec succès!", "success");
                        }
                        
                    } catch (error) {
                        console.error("Erreur PDF:", error);
                        Utils.showMessage("Erreur lors de la génération du PDF: " + error.message, "error");
                    }
                }
            };

            // ================================
            // POINT D'ENTRÉE PRINCIPAL
            // ================================
            const App = {
                init() {
                    // Vérification authentification
                    const username = Utils.getCurrentUser();
                    if (!username) {
                        Utils.redirectToLogin();
                        return;
                    }
                    
                    // Afficher le nom d'utilisateur
                    const usernameDisplay = document.getElementById('username-display');
                    if (usernameDisplay) usernameDisplay.textContent = username;
                    
                    // Mettre à jour l'avatar
                    const profileImg = document.getElementById('profile-image');
                    if (profileImg) {
                        profileImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=6366f1&color=fff`;
                    }
                    
                    // Initialiser les onglets
                    TabManager.init();
                    
                    // Récupérer l'ID du client depuis l'URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const clientId = urlParams.get('id');
                    
                    // Charger les données client
                    ClientData.load(clientId);
                    
                    // Initialiser le système d'appel
                    setTimeout(() => CallManager.ouvrirConsignation(), 1000);
                    
                    // Écouteur pour les changements de statut
                    document.getElementById('status-select').addEventListener('change', () => StatusManager.handleChange());
                },
                
                // Exposition des modules pour les appels onclick
                navigation: {
                    retour: () => window.location.href = 'Accueil.html'
                },
                telephone: CallManager,
                paiement: PaymentManager,
                impression: ImpressionManager
            };

            // Exposer l'application globalement
            window.app = App;
            window.Utils = Utils;
            window.DeliveryManager = DeliveryManager;
            window.PaymentManager = PaymentManager;
            window.StatusManager = StatusManager;

            // Démarrer l'application au chargement
            document.addEventListener('DOMContentLoaded', () => App.init());
        })();
        // Ajouter cet effet optionnel dans votre fonction App.init()
window.addEventListener('scroll', function() {
    const header = document.querySelector('.page-header');
    if (window.scrollY > 50) {
        header.classList.add('scrolled');
    } else {
        header.classList.remove('scrolled');
    }
});
    </script>
</body>
</html>